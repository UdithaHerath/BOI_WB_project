<!DOCTYPE html>
<html>
<head>
    <title>Employee Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function exportAsImage() {
            html2canvas(document.getElementById('dashboard')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'employee-report.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</head>
<body>
    <div id="dashboard">
        <h1>Employee: {{ employee.name }}</h1>
        <p>Employee Number: {{ employee.emp_number }}</p>
        <p>Designation: {{ employee.designation }}</p>

        <h2>Contributions</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Jan</th>
                    <th>Feb</th>
                    <th>Mar</th>
                    <th>Apr</th>
                    <th>May</th>
                    <th>Jun</th>
                    <th>Jul</th>
                    <th>Aug</th>
                    <th>Sep</th>
                    <th>Oct</th>
                    <th>Nov</th>
                    <th>Dec</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for year, months in contributions.items() %}
                    <tr>
                        <td>{{ year }}</td>
                        <td>{{ months.get('January', '') }}</td>
                        <td>{{ months.get('February', '') }}</td>
                        <td>{{ months.get('March', '') }}</td>
                        <td>{{ months.get('April', '') }}</td>
                        <td>{{ months.get('May', '') }}</td>
                        <td>{{ months.get('June', '') }}</td>
                        <td>{{ months.get('July', '') }}</td>
                        <td>{{ months.get('August', '') }}</td>
                        <td>{{ months.get('September', '') }}</td>
                        <td>{{ months.get('October', '') }}</td>
                        <td>{{ months.get('November', '') }}</td>
                        <td>{{ months.get('December', '') }}</td>
                        <td>{{ months.values() | sum }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Loans</h2>
        {% if loans %}
            <ul>
                {% for loan in loans %}
                    <li>
                        Loan No: {{ loan.loan_number }},
                        Amount: {{ loan.loan_amount }},
                        Date: {{ loan.loan_date }},
                        Due: {{ loan.due_amount }},
                        Check: {{ loan.check_number }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No loans recorded.</p>
        {% endif %}

        <h3>Add New Loan</h3>
        <form method="POST" action="/add_loan">
            <input type="hidden" name="emp_number" value="{{ employee.emp_number }}">
            <label>Loan Number: <input type="text" name="loan_number" required></label><br>
            <label>Loan Date: <input type="date" name="loan_date" required></label><br>
            <label>Loan Amount: <input type="number" step="0.01" name="loan_amount" required></label><br>
            <label>Due Amount: <input type="number" step="0.01" name="due_amount" required></label><br>
            <label>Check Number: <input type="text" name="check_number"></label><br>
            <button type="submit">Add Loan</button>
        </form>
    </div>

    <button onclick="exportAsImage()">Download Report as Image</button>
    <p><a href="/">Back to Home</a></p>

<!-- Update the documents table -->
<div class="documents-section">
    <h2>Employee Documents</h2>

    {% if employee.documents %}
        <table class="documents-table">
            <thead>
                <tr>
                    <th>Document Name</th>
                    <th>Upload Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in employee.documents %}
                    <tr>
                        <td>{{ doc.document_name }}</td>
                        <td>{{ doc.upload_date.strftime('%Y-%m-%d') }}</td>
                        <td class="document-actions">
                            <a href="/download_employee_document/{{ doc.file_path }}"
                               class="action-btn download-btn">
                                Download
                            </a>

                            <button class="action-btn rename-btn"
                                    onclick="showRenameForm({{ doc.id }}, '{{ doc.document_name }}')">
                                Rename
                            </button>

                            <form method="POST" action="/delete_employee_document/{{ doc.id }}"
                                  class="delete-form"
                                  onsubmit="return confirm('Are you sure you want to delete this document?');">
                                <button type="submit" class="action-btn delete-btn">Delete</button>
                            </form>
                        </td>
                    </tr>

                    <!-- Rename Form (hidden by default) -->
                    <tr id="rename-form-{{ doc.id }}" class="rename-form" style="display: none;">
                        <td colspan="3">
                            <form method="POST" action="/rename_employee_document/{{ doc.id }}">
                                <input type="text" name="new_name" value="{{ doc.document_name }}"
                                       class="rename-input" required>
                                <button type="submit" class="save-rename-btn">Save</button>
                                <button type="button" class="cancel-rename-btn"
                                        onclick="hideRenameForm({{ doc.id }})">Cancel</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No documents uploaded yet.</p>
    {% endif %}

    <!-- Add this JavaScript for rename functionality -->
    <script>
        function showRenameForm(docId, currentName) {
            // Hide all rename forms first
            document.querySelectorAll('.rename-form').forEach(form => {
                form.style.display = 'none';
            });

            // Show this document's rename form
            const form = document.getElementById(`rename-form-${docId}`);
            form.style.display = '';

            // Focus the input field
            const input = form.querySelector('input[name="new_name"]');
            input.focus();
            input.select();
        }

        function hideRenameForm(docId) {
            document.getElementById(`rename-form-${docId}`).style.display = 'none';
        }
    </script>

    <h3>Upload New Document</h3>
    <form method="POST" action="/upload_employee_document/{{ employee.emp_number }}"
          enctype="multipart/form-data">
        <input type="file" name="document" required>
        <button type="submit">Upload Document</button>
    </form>
</div>

<!-- Update the CSS -->
<style>
    .document-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 6px 12px;
        border-radius: 4px;
        text-decoration: none;
        cursor: pointer;
        border: none;
        font-size: 14px;
    }

    .download-btn {
        background: #17a2b8;
        color: white;
    }

    .rename-btn {
        background: #ffc107;
        color: black;
    }

    .delete-btn {
        background: #dc3545;
        color: white;
    }

    .rename-form {
        background-color: #f8f9fa;
    }

    .rename-input {
        padding: 8px;
        width: 50%;
        margin-right: 10px;
    }

    .save-rename-btn {
        padding: 8px 15px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .cancel-rename-btn {
        padding: 8px 15px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 5px;
    }
</style>


</body>
</html>